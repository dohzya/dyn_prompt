#!/usr/bin/env ruby

begin
 require 'json' 
rescue LoadError => e
  no_json=true
end

require "#{File.dirname(__FILE__)}/dyn_prompt"

def die(msg)
  $stderr.puts msg
  exit 1
end

def print_usage
  name = File.basename(__FILE__)
  $stderr.puts <<USAGE
usage: #{name} [-h]
USAGE
  exit
end

args = ARGV.dup
opts = {}
while arg = args.shift
  case arg
  when '-h','--help'
    print_usage
  when /^-/
    die("unknown argument: #{arg}")
  end
end

vars = DynPrompt.export_env(opts)
vars = vars.inject({}) do |new_vars, (name, value)|
  if value.is_a? Hash
    value.each do |n,v|
      new_vars["prompt_#{name.downcase}_#{n}"] = v
    end
  else
    new_vars[name] = value
  end
  new_vars
end
res = []
vars.each do |name, value|
  val =
    case value
    when nil,String
      value
    else
      no_json ? value : value.to_json
    end
  res << %(export #{name}="#{val}")
end
puts res.join("\n")
